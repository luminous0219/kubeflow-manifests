apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# This kustomization file deploys all Kubeflow components
# It assumes cert-manager, Istio, and Longhorn are already installed

# Build metadata to help with troubleshooting
buildMetadata: [originAnnotations]

sortOptions:
  order: legacy
  legacySortOptions:
    orderFirst:
    - Namespace
    - ResourceQuota
    - StorageClass
    - CustomResourceDefinition
    - MutatingWebhookConfiguration
    - ServiceAccount
    - PodSecurityPolicy
    - NetworkPolicy
    - Role
    - ClusterRole
    - RoleBinding
    - ClusterRoleBinding
    - ConfigMap
    - Secret
    - Endpoints
    - Service
    - LimitRange
    - PriorityClass
    - PersistentVolume
    - PersistentVolumeClaim
    - Deployment
    - StatefulSet
    - CronJob
    - PodDisruptionBudget
    orderLast:
    - ValidatingWebhookConfiguration

resources:
# OAuth2-Proxy (choose ONE of the following based on your cluster)
- ../common/oauth2-proxy/overlays/m2m-dex-only     # for most clusters
# - ../common/oauth2-proxy/overlays/m2m-dex-and-kind # for KIND/K3D/Rancher/GKE (allows K8S JWTs)
# - ../common/oauth2-proxy/overlays/m2m-dex-and-eks  # for EKS (configure issuer first)

# Dex
- ../common/dex/overlays/oauth2-proxy

# Knative Serving (required for KServe)
- ../common/knative/knative-serving/overlays/gateways
- ../common/istio/cluster-local-gateway/base

# Uncomment if you need Knative Eventing
# - ../common/knative/knative-eventing/base

# Kubeflow namespace
- ../common/kubeflow-namespace/base

# Network Policies
- ../common/networkpolicies/base

# Kubeflow Roles
- ../common/kubeflow-roles/base

# Kubeflow Istio Resources
- ../common/istio/kubeflow-istio-resources/base

# Kubeflow Pipelines with SeaweedFS (default S3-compatible storage)
# Pipelines are enabled by default. ArgoCD sync waves handle deployment order.
- ../experimental/seaweedfs/istio
- ../applications/pipeline/upstream/env/cert-manager/platform-agnostic-multi-user

# Alternative: Pipeline definitions as Kubernetes resources (uncomment to use, comment out above)
# - ../applications/pipeline/upstream/env/cert-manager/platform-agnostic-multi-user-k8s-native

# Katib (Hyperparameter Tuning)
- ../applications/katib/upstream/installs/katib-with-kubeflow

# Central Dashboard
- ../applications/centraldashboard/overlays/oauth2-proxy

# Admission Webhook (PodDefaults)
- ../applications/admission-webhook/upstream/overlays/cert-manager

# Jupyter Web App
- ../applications/jupyter/jupyter-web-app/upstream/overlays/istio

# Notebook Controller
- ../applications/jupyter/notebook-controller/upstream/overlays/kubeflow

# Profiles + KFAM with Pod Security Standards
- ../applications/profiles/pss

# PVC Viewer Controller
- ../applications/pvcviewer-controller/upstream/base

# Volumes Web App
- ../applications/volumes-web-app/upstream/overlays/istio

# Tensorboard Controller
- ../applications/tensorboard/tensorboard-controller/upstream/overlays/kubeflow

# Tensorboards Web App
- ../applications/tensorboard/tensorboards-web-app/upstream/overlays/istio

# Trainer (Training Operator v2)
- ../applications/trainer/overlays

# KServe (Model Serving)
- ../applications/kserve/kserve
- ../applications/kserve/models-web-app/overlays/kubeflow

# Spark Operator
- ../applications/spark/spark-operator/overlays/kubeflow

# User namespace (default user)
- ../common/user-namespace/base

# Optional: Model Registry (uncomment if needed)
# - ../applications/model-registry/upstream/overlays/db

components:
# Pod Security Standards - baseline for dynamic namespaces
- ../common/security/PSS/dynamic/baseline

# ArgoCD Sync Waves - Control deployment order to avoid conflicts
patches:
# Wave 1: Namespaces first
- target:
    kind: Namespace
  patch: |-
    - op: add
      path: /metadata/annotations
      value:
        argocd.argoproj.io/sync-wave: "1"

# Wave 2: CRDs before CRs
- target:
    group: apiextensions.k8s.io
    kind: CustomResourceDefinition
  patch: |-
    - op: add
      path: /metadata/annotations
      value:
        argocd.argoproj.io/sync-wave: "2"

# Wave 2: RBAC early (including metacontroller ClusterRole)
- target:
    group: rbac.authorization.k8s.io
    kind: ClusterRole
  patch: |-
    - op: add
      path: /metadata/annotations
      value:
        argocd.argoproj.io/sync-wave: "2"

- target:
    group: rbac.authorization.k8s.io
    kind: ClusterRoleBinding
  patch: |-
    - op: add
      path: /metadata/annotations
      value:
        argocd.argoproj.io/sync-wave: "2"

# Wave 3: ServiceAccounts, Secrets, ConfigMaps
- target:
    kind: ServiceAccount
  patch: |-
    - op: add
      path: /metadata/annotations
      value:
        argocd.argoproj.io/sync-wave: "3"

- target:
    kind: Secret
  patch: |-
    - op: add
      path: /metadata/annotations
      value:
        argocd.argoproj.io/sync-wave: "3"

- target:
    kind: ConfigMap
  patch: |-
    - op: add
      path: /metadata/annotations
      value:
        argocd.argoproj.io/sync-wave: "3"

# Wave 4: Services and PVCs
- target:
    kind: Service
  patch: |-
    - op: add
      path: /metadata/annotations
      value:
        argocd.argoproj.io/sync-wave: "4"

- target:
    kind: PersistentVolumeClaim
  patch: |-
    - op: add
      path: /metadata/annotations
      value:
        argocd.argoproj.io/sync-wave: "4"

# Wave 5: Istio resources
- target:
    group: networking.istio.io
  patch: |-
    - op: add
      path: /metadata/annotations
      value:
        argocd.argoproj.io/sync-wave: "5"

- target:
    group: security.istio.io
  patch: |-
    - op: add
      path: /metadata/annotations
      value:
        argocd.argoproj.io/sync-wave: "5"

# Wave 6: StatefulSets (databases)
- target:
    group: apps
    kind: StatefulSet
  patch: |-
    - op: add
      path: /metadata/annotations
      value:
        argocd.argoproj.io/sync-wave: "6"

# Wave 7: Deployments
- target:
    group: apps
    kind: Deployment
  patch: |-
    - op: add
      path: /metadata/annotations
      value:
        argocd.argoproj.io/sync-wave: "7"

# Wave 8: Webhooks (after deployments)
- target:
    group: admissionregistration.k8s.io
  patch: |-
    - op: add
      path: /metadata/annotations
      value:
        argocd.argoproj.io/sync-wave: "8"

# Wave 9: Custom Resources (after controllers)
- target:
    group: kubeflow.org
    kind: Profile
  patch: |-
    - op: add
      path: /metadata/annotations
      value:
        argocd.argoproj.io/sync-wave: "9"

# Uncomment to add patches for custom domain, user, etc.
# - target:
#     kind: Gateway
#     name: kubeflow-gateway
#   patch: |-
#     - op: replace
#       path: /spec/servers/0/hosts/0
#       value: kubeflow.yourdomain.com
#     - op: replace
#       path: /spec/servers/1/hosts/0
#       value: kubeflow.yourdomain.com

